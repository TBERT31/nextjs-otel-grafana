# OpenTelemetry with Grafana Tempo and Go Application

This project demonstrates distributed tracing using OpenTelemetry, Grafana Tempo, and Grafana.

## Components

1. **Grafana**: Visualization platform
2. **Grafana Tempo**: Distributed tracing backend
3. **Grafana Loki**: Log aggregation system
4. **OpenTelemetry Collector**: Telemetry collection and processing pipeline
5. **Go Application**: Todo application with PostgreSQL backend and OpenTelemetry instrumentation
6. **PostgreSQL**: Database to store todo items

## Architecture

```
┌─────────┐    OTLP     ┌─────────────────┐    OTLP     ┌────────┐    Query   ┌─────────┐
│ Go App  ├────────────►│ OTEL Collector  ├────────────►│ Tempo  │◄───────────┤         │
└────┬────┘             └───────┬─────────┘             └────────┘            │         │
     │                          │                                             │ Grafana │
     │ SQL                      │ Logs                 ┌────────┐    Query    │         │
     ▼                          ▼                      │        │◄────────────┤         │
┌─────────┐              ┌─────────────┐               │  Loki  │             └─────────┘
│ Postgres│              │  Promtail   ├──────────────►│        │
└─────────┘              └─────────────┘               └────────┘
```

## Prerequisites

- Docker
- Docker Compose

## Getting Started

1. Clone this repository
2. Run the docker-compose file:

```bash
docker-compose up -d
```

3. Access the services:
   - Grafana: http://localhost:3000
   - Go Application (Todo App): http://localhost:8080
   - Trace Viewer: http://localhost:8080/traces
   - OpenTelemetry Collector metrics: http://localhost:8888

### Troubleshooting

If you encounter build errors related to Go dependencies:

```
cd app
go mod tidy
```

This will create the necessary `go.sum` file and ensure all dependencies are properly resolved.

## Using the Todo App

The Todo application provides a simple interface to:
- View existing todos
- Add new todos
- Mark todos as complete
- Delete todos

All of these actions are traced using OpenTelemetry, with database operations being captured as spans.

## Using the Trace Viewer

The application includes a built-in trace viewer that allows you to:
1. View recent traces generated by the application
2. Search for traces by:
   - Trace ID
   - Service name (e.g., "go-app" or "postgres")
   - Operation name (e.g., "getAllTodos" or "queryTodos.database")
3. View detailed information about each trace, including:
   - Span hierarchy
   - Duration of each span
   - Attributes attached to spans
   - Waterfall view of span timing

This provides an easy way to understand the performance characteristics of your application without leaving the app.

## View Traces in Grafana

For more advanced trace analysis, you can also view traces in Grafana:

1. Go to Grafana at http://localhost:3000
2. Navigate to Explore
3. Select Tempo as the data source
4. Use TraceQL to query traces
5. Try filtering for database operations by searching for spans with names like `queryTodos.database`

## Structure

- `docker-compose.yml`: Main configuration file for all services
- `app/`: Contains Go application with OpenTelemetry instrumentation
- `tempo/`: Contains Tempo configuration
- `grafana/`: Contains Grafana provisioning files
- `otel-collector/`: Contains OpenTelemetry Collector configuration
- `postgres/`: Contains PostgreSQL initialization scripts

## OpenTelemetry Collector

The OpenTelemetry Collector serves as an intermediary between your applications and observability backends. It provides:

1. **Telemetry Collection**: Receives traces, metrics, and logs from instrumented applications
2. **Processing**: Batches, filters, and enriches telemetry data
3. **Export**: Sends processed data to one or more backends

In this setup, the collector:
- Receives OTLP data from the Go application via gRPC (port 4317)
- Processes the data (batching, resource attribute addition)
- Exports traces to Tempo and also logs them for debugging

## PostgreSQL Integration

The Todo application uses PostgreSQL to store and retrieve todo items. Each database operation is traced using OpenTelemetry:

- `queryTodos.database`: Fetches all todos
- `createTodo.database`: Creates a new todo
- `updateTodo.database`: Updates a todo
- `deleteTodo.database`: Deletes a todo

This allows you to see the performance of your database operations and how they impact the overall request.

## Trace Querying

The application provides multiple ways to query and view traces:

1. **Built-in Trace Viewer**: Access via `/traces` URL path
   - Simple interface for viewing recent traces
   - Search capabilities for finding specific traces
   - Detailed trace view with waterfall visualization

2. **Grafana Tempo**: Access via Grafana
   - Advanced querying with TraceQL
   - Integration with other observability data
   - More sophisticated visualization options

## Logs and Traces

This project uses Grafana Loki for log aggregation and connects logs to traces for a seamless debugging experience:

1. **Structured Logging**: The Go application produces structured logs in JSON format with embedded trace IDs
2. **Log Collection**: Promtail collects logs from the Go application container
3. **Trace Context**: Each log entry contains the trace ID when it's part of a traced operation
4. **Log-to-Trace Correlation**: In Grafana, you can navigate from logs to traces and vice versa

### Viewing Correlated Logs and Traces

1. Go to Grafana at http://localhost:3000
2. Navigate to Explore
3. Select Loki as the data source
4. Query logs with: `{container="go-app"}`
5. Find a log with a trace ID and click on the trace link to jump directly to the trace details
6. Alternatively, when viewing a trace, you can see related logs that share the same trace ID

This powerful correlation makes debugging much easier by connecting what happened (logs) with the execution flow (traces).

## Notes

- Tempo is configured to store traces locally with a retention period of 1 hour
- The Go application uses OpenTelemetry to send traces to the collector
- The collector forwards traces to Tempo
- Grafana is configured with anonymous access for easy exploration
- The trace viewer in the Go application shows sample traces for demonstration purposes